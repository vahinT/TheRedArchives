<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Red Archives Explorer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #e5e7eb; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .slide-in-right { animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1); }

        .glass-panel {
            background: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(12px);
            border-left: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        /* Markdown Styles for Analysis */
        .prose h1, .prose h2, .prose h3 { color: #f87171; margin-top: 1.2em; margin-bottom: 0.5em; font-weight: 600; font-size: 1.1em; }
        .prose p { margin-bottom: 0.8em; line-height: 1.5; color: #d1d5db; font-size: 0.95em; }
        .prose code { background: rgba(255,0,0,0.1); color: #fca5a5; padding: 0.2em 0.4em; border-radius: 0.25em; font-size: 0.85em; font-family: monospace; }
        .prose pre { background: #000; padding: 1em; border-radius: 0.5em; overflow-x: auto; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 1em; }
        .prose pre code { background: transparent; color: #e5e7eb; padding: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose strong { color: white; font-weight: 600; }
    </style>
</head>
<body class="overflow-hidden h-screen flex flex-col selection:bg-red-500/30">

    <!-- Background Gradients -->
    <div class="fixed inset-0 z-0 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-red-900/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-900/10 rounded-full blur-[120px]"></div>
    </div>

    <!-- Header -->
    <header class="relative z-20 h-14 border-b border-white/5 bg-[#0a0a0a]/80 backdrop-blur-md flex items-center justify-between px-4 lg:px-6 shrink-0">
        <div class="flex items-center gap-3">
            <button id="mobile-menu-btn" class="lg:hidden p-2 hover:bg-white/10 rounded-lg text-gray-400">
                <i data-lucide="menu" class="w-5 h-5"></i>
            </button>
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-red-600 to-rose-700 flex items-center justify-center shadow-lg shadow-red-900/20">
                <i data-lucide="github" class="text-white w-5 h-5"></i>
            </div>
            <h1 class="font-bold text-base tracking-tight text-white hidden sm:block">
                The<span class="text-red-500">Red</span>Archives
            </h1>
        </div>

        <div class="flex items-center gap-3">
            <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs text-gray-400">
                <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                <span id="status-text">System Online</span>
            </div>
            <button id="settings-btn" class="p-2 rounded-full hover:bg-white/5 text-gray-400 hover:text-white transition-colors">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-1 relative z-10 flex overflow-hidden">
        
        <!-- Sidebar (File Tree) -->
        <aside id="sidebar" class="absolute lg:static inset-y-0 left-0 z-30 w-72 bg-[#0e0e0e]/95 backdrop-blur-xl lg:bg-transparent border-r border-white/5 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 flex flex-col">
            <div class="p-3 border-b border-white/5">
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 w-3.5 h-3.5"></i>
                    <input type="text" id="file-search" placeholder="Search files..." class="w-full bg-white/5 border border-white/10 rounded-lg py-1.5 pl-9 pr-3 text-xs text-gray-300 focus:outline-none focus:border-red-500/50 transition-colors placeholder-gray-600">
                </div>
            </div>
            
            <div id="file-tree" class="flex-1 overflow-y-auto py-2 scrollbar-thin">
                <div class="flex flex-col items-center justify-center h-40 gap-3 text-gray-500">
                    <div class="w-5 h-5 border-2 border-red-500 border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-xs">Initializing...</span>
                </div>
            </div>
        </aside>

        <!-- Overlay for mobile sidebar -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden backdrop-blur-sm"></div>

        <!-- Main Content View -->
        <main class="flex-1 overflow-y-auto bg-[#0a0a0a] relative flex flex-col w-full" id="main-view">
            
            <!-- Welcome State -->
            <div id="welcome-screen" class="flex-1 flex flex-col items-center justify-center text-center p-8 opacity-50">
                <div class="w-20 h-20 bg-gradient-to-br from-white/5 to-transparent rounded-2xl flex items-center justify-center mb-6 border border-white/10">
                    <i data-lucide="layout-grid" class="w-10 h-10 text-gray-600"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-300 mb-2">Ready to Explore</h2>
                <p class="text-gray-500 max-w-sm text-sm">Select a file to view source code, download assets, or run AI diagnostics.</p>
            </div>

            <!-- File View State (Hidden by default) -->
            <div id="file-view" class="hidden flex-col min-h-full">
                <!-- File Header -->
                <div class="sticky top-0 z-20 bg-[#0a0a0a]/90 backdrop-blur-md border-b border-white/5 p-3 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <button id="back-btn" class="lg:hidden p-1 text-gray-400">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        </button>
                        <div class="p-1.5 bg-white/5 rounded-lg border border-white/10 text-gray-400" id="file-icon-container"></div>
                        <div class="flex flex-col min-w-0">
                            <h2 id="current-filename" class="font-medium text-sm text-white truncate">filename.ext</h2>
                            <p id="current-path" class="text-[10px] text-gray-500 truncate font-mono">path/to/file</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2">
                        <a id="download-btn" href="#" target="_blank" class="flex items-center justify-center gap-2 px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 text-gray-200 border border-white/10 transition-all text-xs font-medium">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i>
                            <span class="hidden sm:inline">Raw</span>
                        </a>
                        <button id="analyze-btn" class="flex items-center justify-center gap-2 px-3 py-1.5 rounded-lg bg-gradient-to-r from-red-600 to-rose-600 hover:from-red-500 hover:to-rose-500 text-white shadow-lg shadow-red-900/20 border border-red-500/20 transition-all duration-300 font-medium active:scale-95 text-xs">
                            <i data-lucide="sparkles" class="w-3.5 h-3.5"></i>
                            <span class="hidden sm:inline">Analyze</span>
                        </button>
                    </div>
                </div>

                <!-- File Content Area -->
                <div class="flex-1 p-4 lg:p-8 max-w-6xl mx-auto w-full">
                    
                    <!-- Loading Spinner -->
                    <div id="content-loader" class="hidden flex-col items-center justify-center py-20 gap-4">
                        <div class="w-8 h-8 border-2 border-red-500/30 border-t-red-500 rounded-full animate-spin"></div>
                        <p class="text-gray-500 animate-pulse text-xs">Retrieving data...</p>
                    </div>

                    <!-- Image Preview -->
                    <div id="image-preview" class="hidden justify-center p-8 bg-black/20 rounded-xl border border-white/10">
                        <img id="preview-img" src="" alt="Preview" class="max-w-full max-h-[60vh] object-contain rounded-lg shadow-2xl">
                    </div>

                    <!-- Code/Text Preview -->
                    <div id="code-preview" class="hidden">
                        <div class="bg-[#111] rounded-xl border border-white/10 overflow-hidden shadow-2xl relative group">
                            <button id="copy-btn" class="absolute top-2 right-2 px-2 py-1 text-[10px] bg-white/5 hover:bg-white/10 text-gray-300 rounded border border-white/10 opacity-0 group-hover:opacity-100 transition-opacity">
                                Copy
                            </button>
                            <pre class="p-4 overflow-x-auto text-xs font-mono leading-relaxed text-gray-300"><code id="code-content"></code></pre>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Analysis Sidebar (Right Side) -->
        <aside id="analysis-sidebar" class="fixed inset-y-0 right-0 z-40 w-full sm:w-96 glass-panel transform translate-x-full transition-transform duration-300 flex flex-col shadow-2xl shadow-black">
            <div class="flex items-center justify-between p-4 border-b border-white/10 bg-black/20">
                <div class="flex items-center gap-2">
                    <i data-lucide="brain" class="text-red-400 w-5 h-5"></i>
                    <h3 class="font-semibold text-white">Gemini Analysis</h3>
                </div>
                <button id="close-analysis" class="text-gray-400 hover:text-white transition-colors p-1 hover:bg-white/10 rounded-md">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5 scrollbar-thin">
                <!-- Loader -->
                <div id="analysis-loader" class="hidden flex-col items-center justify-center h-full gap-4 text-center">
                    <div class="relative">
                        <div class="w-10 h-10 border-2 border-red-500/20 rounded-full"></div>
                        <div class="absolute top-0 left-0 w-10 h-10 border-2 border-red-500 border-t-transparent rounded-full animate-spin"></div>
                        <i data-lucide="sparkles" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white w-4 h-4"></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-200 font-medium">Analyzing Code...</p>
                        <p class="text-xs text-gray-500 mt-1">Checking for bugs, logic, and vibes.</p>
                    </div>
                </div>

                <!-- Content -->
                <div id="analysis-result" class="hidden prose prose-invert max-w-none text-sm">
                    <!-- Markdown injected here -->
                </div>
            </div>
        </aside>

    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm fade-in">
        <div class="bg-[#1a1a1a] border border-white/10 rounded-2xl w-full max-w-md shadow-2xl overflow-hidden transform scale-95 transition-transform duration-200" id="settings-content">
            <div class="flex justify-between items-center p-4 border-b border-white/10 bg-white/5">
                <h3 class="text-sm font-bold text-white bg-clip-text text-transparent bg-gradient-to-r from-red-400 to-rose-400">
                    Configuration
                </h3>
                <button id="close-settings" class="text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="p-6 space-y-5">
                
                <!-- API Key Status -->
                <div class="space-y-2">
                    <label class="block text-xs font-medium text-gray-400">Gemini AI Key</label>
                    <div class="flex items-center justify-between bg-green-500/10 border border-green-500/20 px-3 py-2 rounded-lg">
                        <div class="flex items-center gap-2">
                            <i data-lucide="shield-check" class="text-green-400 w-4 h-4"></i>
                            <span class="text-xs text-green-200 font-medium">System Key Loaded</span>
                        </div>
                    </div>
                    <input type="password" id="input-custom-key" placeholder="Enter custom key to override (Optional)" class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-xs text-white focus:outline-none focus:border-red-500/50 transition-colors mt-2">
                </div>

                <!-- GitHub Token -->
                <div class="space-y-2">
                    <label class="block text-xs font-medium text-gray-400">GitHub Token (Optional)</label>
                    <input type="password" id="input-gh-token" placeholder="ghp_xxxxxxxxxxxx" class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-xs text-white focus:outline-none focus:border-red-500/50 transition-colors">
                    <p class="text-[10px] text-gray-500">Increases rate limit from 60 to 5000 req/hr.</p>
                </div>
                
                <!-- Repo Config -->
                <div class="pt-4 border-t border-white/10">
                    <h4 class="text-xs font-medium text-gray-400 mb-2">Target Repository</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="input-owner" value="vahinT" class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-xs" placeholder="Owner">
                        <input type="text" id="input-repo" value="TheRedArchives" class="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-xs" placeholder="Repo">
                    </div>
                    <div class="mt-3 flex justify-end">
                        <button id="reload-repo-btn" class="bg-white/5 hover:bg-white/10 text-gray-200 border border-white/10 px-3 py-1.5 rounded-lg text-xs font-medium transition-colors">
                            Reload Repo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- State ---
        // Base64 encoded key: xxxxx
        const DEFAULT_GEMINI_KEY_B64 = "QUl6YVN5QWI4Vi1sMVFUZjByR3c1cllmWkxCWXlXZVdfcEp4TWhR";

        const state = {
            owner: 'vahinT',
            repo: 'TheRedArchives',
            branch: 'main',
            ghToken: '',
            customGeminiKey: '', // User override
            currentFile: null,
            fileContent: null
        };

        // --- DOM Elements ---
        const els = {
            fileTree: document.getElementById('file-tree'),
            welcomeScreen: document.getElementById('welcome-screen'),
            fileView: document.getElementById('file-view'),
            currentFilename: document.getElementById('current-filename'),
            currentPath: document.getElementById('current-path'),
            fileIconContainer: document.getElementById('file-icon-container'),
            downloadBtn: document.getElementById('download-btn'),
            codeContent: document.getElementById('code-content'),
            contentLoader: document.getElementById('content-loader'),
            imagePreview: document.getElementById('image-preview'),
            previewImg: document.getElementById('preview-img'),
            codePreview: document.getElementById('code-preview'),
            settingsModal: document.getElementById('settings-modal'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            // New Analysis Sidebar Elements
            analysisSidebar: document.getElementById('analysis-sidebar'),
            analysisLoader: document.getElementById('analysis-loader'),
            analysisResult: document.getElementById('analysis-result'),
            closeAnalysisBtn: document.getElementById('close-analysis'),
            // Inputs
            inputOwner: document.getElementById('input-owner'),
            inputRepo: document.getElementById('input-repo'),
            inputGhToken: document.getElementById('input-gh-token'),
            inputCustomKey: document.getElementById('input-custom-key'),
            fileSearch: document.getElementById('file-search')
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadSettings();
            fetchRepo();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Sidebar Toggles
            document.getElementById('mobile-menu-btn').addEventListener('click', () => toggleSidebar(true));
            document.getElementById('back-btn').addEventListener('click', () => toggleSidebar(true));
            els.sidebarOverlay.addEventListener('click', () => toggleSidebar(false));

            // Settings
            document.getElementById('settings-btn').addEventListener('click', () => toggleModal(true));
            document.getElementById('close-settings').addEventListener('click', () => toggleModal(false));
            document.getElementById('reload-repo-btn').addEventListener('click', () => {
                saveSettings();
                toggleModal(false);
                fetchRepo();
            });

            // Actions
            document.getElementById('analyze-btn').addEventListener('click', runGeminiAnalysis);
            els.closeAnalysisBtn.addEventListener('click', closeAnalysisSidebar);
            
            document.getElementById('copy-btn').addEventListener('click', () => {
                if(state.fileContent) navigator.clipboard.writeText(state.fileContent);
            });

            // Search
            els.fileSearch.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const items = document.querySelectorAll('.tree-item');
                items.forEach(item => {
                    const name = item.getAttribute('data-name').toLowerCase();
                    item.style.display = name.includes(term) ? 'flex' : 'none';
                });
            });
        }

        // --- Core Logic ---

        function loadSettings() {
            els.inputOwner.value = state.owner;
            els.inputRepo.value = state.repo;
            els.inputGhToken.value = state.ghToken;
            els.inputCustomKey.value = state.customGeminiKey;
        }

        function saveSettings() {
            state.owner = els.inputOwner.value;
            state.repo = els.inputRepo.value;
            state.ghToken = els.inputGhToken.value;
            state.customGeminiKey = els.inputCustomKey.value;
        }

        async function fetchRepo() {
            els.fileTree.innerHTML = `
                <div class="flex flex-col items-center justify-center h-40 gap-3 text-gray-500">
                    <div class="w-5 h-5 border-2 border-red-500 border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-xs">Fetching ${state.owner}/${state.repo}...</span>
                </div>
            `;
            
            try {
                const headers = state.ghToken ? { Authorization: `token ${state.ghToken}` } : {};
                
                const repoRes = await fetch(`https://api.github.com/repos/${state.owner}/${state.repo}`, { headers });
                if (!repoRes.ok) throw new Error("Repo not found or access denied.");
                const repoData = await repoRes.json();
                state.branch = repoData.default_branch;

                const treeUrl = `https://api.github.com/repos/${state.owner}/${state.repo}/git/trees/${state.branch}?recursive=1`;
                const treeRes = await fetch(treeUrl, { headers });
                
                if (treeRes.status === 403) throw new Error("Rate limit exceeded. Add Token in Settings.");
                if (!treeRes.ok) throw new Error("Failed to load tree.");
                
                const treeData = await treeRes.json();
                const hierarchy = buildHierarchy(treeData.tree);
                
                els.fileTree.innerHTML = '';
                if(hierarchy.length === 0) {
                    els.fileTree.innerHTML = '<div class="p-4 text-center text-gray-500 text-xs">Empty Repository</div>';
                } else {
                    hierarchy.forEach(node => els.fileTree.appendChild(createTreeNode(node)));
                }
                
                lucide.createIcons();

            } catch (err) {
                els.fileTree.innerHTML = `
                    <div class="p-4 text-center">
                        <i data-lucide="alert-circle" class="mx-auto text-red-500 mb-2 w-5 h-5"></i>
                        <p class="text-xs text-red-400 mb-4">${err.message}</p>
                        <button onclick="fetchRepo()" class="text-xs border border-red-500/30 text-red-400 px-3 py-1 rounded hover:bg-red-500/10">Retry</button>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function buildHierarchy(flatTree) {
            const root = [];
            const map = { "": root };
            
            flatTree.forEach(file => {
                const parts = file.path.split('/');
                const fileName = parts.pop();
                const dirPath = parts.join('/');
                
                if (!map[dirPath]) return;
                
                const node = {
                    name: fileName,
                    path: file.path,
                    type: file.type === 'blob' ? 'file' : 'folder',
                    children: []
                };

                if (node.type === 'folder') map[file.path] = node.children;
                map[dirPath].push(node);
            });

            const sortNodes = (nodes) => {
                nodes.sort((a, b) => {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type === 'folder' ? -1 : 1;
                });
                nodes.forEach(n => { if(n.children.length) sortNodes(n.children); });
            };
            sortNodes(root);
            return root;
        }

        // --- UI Builders ---

        function createTreeNode(node, level = 0) {
            const container = document.createElement('div');
            const padding = level * 12 + 12;
            
            const row = document.createElement('div');
            row.className = 'tree-item flex items-center gap-2 py-1.5 px-2 mx-2 rounded-lg cursor-pointer transition-all duration-200 text-gray-400 hover:bg-white/5 hover:text-gray-200 select-none';
            row.style.paddingLeft = `${padding}px`;
            row.setAttribute('data-path', node.path);
            row.setAttribute('data-name', node.name);
            
            const iconName = node.type === 'folder' ? 'folder' : getFileIconName(node.name);
            const iconColor = node.type === 'folder' ? 'text-yellow-500/80' : 'text-gray-500';
            
            row.innerHTML = `
                <div class="flex-shrink-0 w-3.5">${node.type === 'folder' ? '<i data-lucide="chevron-right" class="w-3 h-3 transition-transform duration-200 chevron"></i>' : ''}</div>
                <div class="flex-shrink-0 ${iconColor}"><i data-lucide="${iconName}" class="w-3.5 h-3.5"></i></div>
                <span class="truncate text-xs font-medium">${node.name}</span>
            `;

            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'hidden border-l border-white/5 ml-[22px]';

            row.addEventListener('click', (e) => {
                e.stopPropagation();
                if (node.type === 'folder') {
                    const isOpen = !childrenContainer.classList.contains('hidden');
                    if (isOpen) {
                        childrenContainer.classList.add('hidden');
                        row.querySelector('.chevron').style.transform = 'rotate(0deg)';
                    } else {
                        childrenContainer.classList.remove('hidden');
                        row.querySelector('.chevron').style.transform = 'rotate(90deg)';
                    }
                } else {
                    loadFile(node);
                }
            });

            container.appendChild(row);
            
            if (node.children.length > 0) {
                node.children.forEach(child => {
                    childrenContainer.appendChild(createTreeNode(child, level + 1));
                });
                container.appendChild(childrenContainer);
            }
            return container;
        }

        function getFileIconName(name) {
            if (name.match(/\.(js|jsx|ts|tsx|py|html|css|json)$/i)) return 'file-code';
            if (name.match(/\.(md|txt)$/i)) return 'file-text';
            if (name.match(/\.(jpg|png|gif|svg)$/i)) return 'image';
            return 'file';
        }

        // --- File Handling ---

        async function loadFile(file) {
            state.currentFile = file;
            state.fileContent = null;
            closeAnalysisSidebar(); // Auto-close analysis when switching files
            
            els.welcomeScreen.classList.add('hidden');
            els.fileView.classList.remove('hidden');
            els.fileView.classList.add('flex');
            
            els.currentFilename.innerText = file.name;
            els.currentPath.innerText = file.path;
            
            // Highlight active item
            document.querySelectorAll('.tree-item').forEach(el => {
                el.classList.remove('bg-red-500/10', 'text-red-200');
                if(el.getAttribute('data-path') === file.path) {
                    el.classList.add('bg-red-500/10', 'text-red-200');
                }
            });

            const iconName = getFileIconName(file.name);
            els.fileIconContainer.innerHTML = `<i data-lucide="${iconName}" class="w-4 h-4"></i>`;
            lucide.createIcons();

            const rawUrl = `https://raw.githubusercontent.com/${state.owner}/${state.repo}/${state.branch}/${file.path}`;
            els.downloadBtn.href = rawUrl;
            
            els.contentLoader.style.display = 'flex';
            els.imagePreview.classList.add('hidden');
            els.codePreview.classList.add('hidden');
            
            if (window.innerWidth < 1024) toggleSidebar(false);

            try {
                const res = await fetch(rawUrl);
                if (!res.ok) throw new Error("Failed to fetch");

                const isImage = file.name.match(/\.(jpg|jpeg|png|gif|webp|svg|ico)$/i);
                
                if (isImage) {
                    els.previewImg.src = rawUrl;
                    els.contentLoader.style.display = 'none';
                    els.imagePreview.classList.remove('hidden');
                    els.imagePreview.classList.add('flex');
                } else {
                    const text = await res.text();
                    state.fileContent = text;
                    els.codeContent.textContent = text;
                    els.contentLoader.style.display = 'none';
                    els.codePreview.classList.remove('hidden');
                    els.codePreview.classList.add('block');
                }
            } catch (err) {
                els.contentLoader.style.display = 'none';
                alert("Error: " + err.message);
            }
        }

        // --- Gemini AI ---

        function openAnalysisSidebar() {
            els.analysisSidebar.classList.remove('translate-x-full');
        }

        function closeAnalysisSidebar() {
            els.analysisSidebar.classList.add('translate-x-full');
        }

        async function runGeminiAnalysis() {
            if (!state.fileContent) return;
            
            // Use custom key if provided, otherwise decode default key
            const apiKey = state.customGeminiKey || atob(DEFAULT_GEMINI_KEY_B64);

            openAnalysisSidebar();
            els.analysisLoader.style.display = 'flex';
            els.analysisResult.classList.add('hidden');

            const prompt = `
                You are a senior developer code reviewer. 
                Analyze this file: ${state.currentFile.name}
                Path: ${state.currentFile.path}
                
                Structure your response in Markdown:
                ## âš¡ Summary
                (One sentence)

                ## ðŸ§  Key Logic
                (Bullet points of what it actually does)

                ## ðŸž Bugs & Risks
                (Any security issues or bad practices? If none, say "Clean".)

                ## ðŸ’Ž Rating: X/10
                (Justify briefly)
                
                Code Snippet:
                ${state.fileContent.substring(0, 20000)}
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message);

                const analysisText = data.candidates?.[0]?.content?.parts?.[0]?.text || "No analysis returned.";
                
                els.analysisResult.innerHTML = marked.parse(analysisText);
                els.analysisLoader.style.display = 'none';
                els.analysisResult.classList.remove('hidden');

            } catch (err) {
                els.analysisLoader.style.display = 'none';
                els.analysisResult.innerHTML = `
                    <div class="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-200 text-xs">
                        <strong>Error:</strong> ${err.message}
                    </div>
                `;
                els.analysisResult.classList.remove('hidden');
            }
        }

        function toggleSidebar(force) {
            const isClosed = els.sidebar.classList.contains('-translate-x-full');
            const shouldOpen = force !== undefined ? force : isClosed;
            
            if (shouldOpen) {
                els.sidebar.classList.remove('-translate-x-full');
                els.sidebarOverlay.classList.remove('hidden');
            } else {
                els.sidebar.classList.add('-translate-x-full');
                els.sidebarOverlay.classList.add('hidden');
            }
        }

        function toggleModal(open) {
            if (open) {
                els.settingsModal.classList.remove('hidden');
                loadSettings();
            } else {
                els.settingsModal.classList.add('hidden');
            }
        }

    </script>
</body>
</html>
